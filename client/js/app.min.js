angular.module("rssreader",["ui.router","ngValidate","auth0","angular-storage","angular-jwt"]).config(["$stateProvider","$urlRouterProvider","$httpProvider","authProvider","jwtInterceptorProvider",function(e,r,t,o,l){o.on("loginSuccess",["$location","profilePromise","idToken","store",function(e,r,t,o){console.log("Login Success"),r.then(function(r){o.set("profile",r),o.set("token",t),console.log(r),console.log(t),e.path("/dashboard")})}]),o.on("loginFailure",function(){console.log("Error logging in"),$location.path("http://localhost:8080/#/login")}),o.init({domain:"kasjs.eu.auth0.com",clientID:"67EH9djYM9SB4AnOnjO1e8A8o3zyrHS1",loginUrl:"http://localhost:8080/#/dashboard"}),r.otherwise("home"),e.state("home",{url:"/home",templateUrl:"./partials/home.html",controller:"HomeController"}).state("login",{url:"/login",templateUrl:"./partials/auth/login.html",controller:"AuthController"}).state("loginAuth",{url:"/loginAuth",templateUrl:"partials/auth/loginAuth.html",controller:"AuthController"}).state("logoutAuth",{url:"/logoutAuth",templateUrl:"partials/auth/logoutAuth.html",controller:"AuthController"}).state("register",{url:"/register",templateUrl:"./partials/auth/register.html",controller:"AuthController"}).state("profile",{url:"/profile",templateUrl:"./partials/auth/profile.html",controller:"ProfileController"}).state("dashboard",{url:"/dashboard",views:{"":{templateUrl:"./partials/dashboard/dashboard.html",controller:"DashboardController"},"sidebar@dashboard":{templateUrl:"./partials/dashboard/sidebar.html",controller:"SidebarController"}},resolve:{feedPromise:["feedsService",function(e){return e.getAllFeeds()}]}}).state("dashboard.th-large",{url:"/th-large",templateUrl:"./partials/list/th-large.html",controller:"ArticlesController",resolve:{articlesPromise:["articlesService",function(e){return e.getAllArticles()}]}}).state("dashboard.list",{url:"/list",templateUrl:"./partials/list/list.html",controller:"ArticlesController",resolve:{articlesPromise:["articlesService",function(e){return e.getAllArticles()}]}}).state("dashboard.th-list",{url:"/th-list",templateUrl:"./partials/list/th-list.html",controller:"ArticlesController",resolve:{articlesPromise:["articlesService",function(e){return e.getAllArticles()}]}}).state("dashboard.addFeed",{url:"/add",templateUrl:"./partials/dashboard/add-feed.html",controller:"FeedsController"}),l.tokenGetter=["store",function(e){return e.get("token")}],t.interceptors.push("jwtInterceptor")}]).run(["$rootScope","auth","store","jwtHelper","$location",function(e,r,t,o,l){e.$on("$locationChangeStart",function(){var e=t.get("token");e&&(o.isTokenExpired(e)?l.path("/login"):r.isAuthenticated||r.authenticate(t.get("profile"),e))})}]),angular.module("rssreader").controller("ArticlesController",["$scope","$state","articlesService",function(e,r,t){e.articles=t.articles,e.title="All"}]),angular.module("rssreader").controller("AuthController",["$scope","$state","authService","$window","auth","store","$location",function(e,r,t,o,l,n,a){e.user={},e.session,e.auth=l,console.log(l),e.logout=function(){l.signout(),n.remove("profile"),n.remove("token"),a.path("/login")},e.register=function(o){console.log(e.user),o.validate()&&t.register(e.user).error(function(r){e.error=r}).then(function(){r.go("dashboard.th-large")})},e.logIn=function(n){n.validate()&&t.logIn(e.user,e.session).error(function(r){e.error=r}).then(function(){e.session?console.log("Checked"):(console.log("Not checked"),e.onExit=function(){l.logOut()},o.onbeforeunload=e.onExit),r.go("dashboard.th-large",{id:t.userID()})})},e.validationLoginOptions={rules:{mail:{required:!0,email:!0},pwd:{required:!0}},messages:{mail:{required:"This field is required ",email:"Please, use example: jacksparrow@gmail.com"},pwd:{required:"This field is required "}}},e.validationRegistrOptions={rules:{mail:{required:!0,email:!0,minlength:9,maxlength:20},pwd:{required:!0,minlength:6,maxlength:20},reppwd:{required:!0,minlength:6,maxlength:20}},messages:{mail:{required:"This field is required ",email:"Please, use example: jacksparrow@gmail.com ",minlength:"Please, enter at least 9 characters ",maxlength:"Please, enter no more than 20 characters. "},pwd:{required:"This field is required ",minlength:"Please, enter at least 6 characters ",maxlength:"Please, enter no more than 20 characters. "},reppwd:{required:"This field is required ",minlength:"Please, enter at least 6 characters ",maxlength:"Please, enter no more than 20 characters. "}}}}]),angular.module("rssreader").controller("DashboardController",["$scope","$state","dashboardService",function(e,r,t){r.title=t.title}]),angular.module("rssreader").controller("FeedsController",["$scope","$state","feedsService",function(e,r,t){e.test="Hello world!",e.obj={},e.feeds=t.feedsDictionary,e.categories=t.CATEGORIES,e.addFeed=function(){e.error="",t.addFeed(e.obj).then(function(e){r.go("dashboard.th-large")},function(r){r.data?e.error=r.data.message:e.error=r.message})}}]),angular.module("rssreader").controller("HomeController",["$scope","$state","authService",function(e,r,t){e.header="Welcome to Rss Reader",e.isLoggedIn=t.isLoggedIn,e.currentUser=t.currentUser,e.OnFeeds=function(){t.isLoggedIn()?r.go("dashboard.th-large",{id:t.userID()}):alert("Unauthtorized")},e.OnRegister=function(){r.go("register")},e.OnLogin=function(){r.go("login")}}]),angular.module("rssreader").controller("NavbarController",["$scope","$state","authService",function(e,r,t){e.isLoggedIn=t.isLoggedIn,e.currentUser=t.currentUser,e.logOut=function(){t.logOut(),r.go("home")},e.goHome=function(){r.go("home")}}]),angular.module("rssreader").controller("ProfileController",["$scope","$state","authService","$window",function(e,r,t,o){e.user={},e.layout="style2",e.layouts=[{name:"Blue",url:"style"},{name:"Black",url:"style2"},{name:"Grey",url:"style3"}]}]),angular.module("rssreader").controller("SidebarController",["$scope","$state","feedsService","articlesService","dashboardService",function(e,r,t,o,l){e.feeds=t.feedsDictionary,e.getAll=function(){o.getAllArticles(),l.setTitle("All"),r.go("dashboard.th-large")},e.getByFeed=function(e,t){o.getArticlesByFeed(e),l.setTitle(t),r.go("dashboard.th-large")},e.getByCat=function(e){o.getArticlesByCat(e),l.setTitle(e),r.go("dashboard.th-large")},e.removeFeed=function(e){t.removeFeed(e),r.reload()}}]),angular.module("rssreader").service("articlesService",["$http","authService",function(e,r){var t={articles:[]},o=10;return t.getAllArticles=function(){t.articles.length=0;var l="all";return e.get("/users/"+r.userID()+"/articles/"+l+"/"+o,{headers:{Authorization:"Bearer "+r.getToken()}}).then(function(e){console.log("All articles recieved:"),angular.forEach(e.data,function(e,r){angular.forEach(e.articles,function(e,r){t.articles.push(e)})}),console.log(t.articles)})},t.getArticlesByFeed=function(l){t.articles.length=0;var n="feed";return e.get("/users/"+r.userID()+"/articles/"+n+"/"+l+"/"+o,{headers:{Authorization:"Bearer "+r.getToken()}}).then(function(e){console.log("articles recieved for feed"+l+":"),angular.copy(e.data.articles,t.articles),console.log(e.data.articles)})},t.getArticlesByCat=function(l){t.articles.length=0;var n="category";return e.get("/users/"+r.userID()+"/articles/"+n+"/"+l+"/"+o,{headers:{Authorization:"Bearer "+r.getToken()}}).then(function(e){console.log("All articles for category "+l+" recieved: "),angular.forEach(e.data,function(e,r){angular.forEach(e.articles,function(e,r){t.articles.push(e)})}),console.log(t.articles)})},t}]),angular.module("rssreader").factory("authService",["$http","$window",function(e,r){var t={};return t.saveToken=function(e){r.localStorage["rss-reader-token"]=e},t.getToken=function(){return r.localStorage["rss-reader-token"]},t.isLoggedIn=function(){var e=t.getToken();if(e){var o=JSON.parse(r.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}return!1},t.currentUser=function(){if(t.isLoggedIn()){var e=t.getToken(),o=JSON.parse(r.atob(e.split(".")[1]));return o.email}},t.userID=function(){if(t.isLoggedIn()){var e=t.getToken(),o=JSON.parse(r.atob(e.split(".")[1]));return o._id}},t.register=function(r){return e.post("/register",r).success(function(e){t.saveToken(e.token)}).error(function(e){console.log(e.message)})},t.logIn=function(r){return e.post("/login",r).success(function(e){t.saveToken(e.token)}).error(function(e){console.log(e.message)})},t.logOut=function(){r.localStorage.removeItem("rss-reader-token")},t}]),angular.module("rssreader").factory("dashboardService",function(){var e={title:""};return e.setTitle=function(e){console.log(e),this.title=e},e}),angular.module("rssreader").service("feedsService",["$http","authService",function(e,r){var t={feedsDictionary:[],allArticles:[],CATEGORIES:["News","IT","Sport","Design","Movies","Music","Culture","Nature","Economics","Science"]};return t.getAllFeeds=function(){return e.get("/users/"+r.userID(),{headers:{Authorization:"Bearer "+r.getToken()}}).then(function(e){console.log(e.data),angular.copy(e.data,t.feedsDictionary)})},t.addFeed=function(t){return e.jsonp("https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=10&q="+t.link+"&callback=JSON_CALLBACK").then(function(o){if(null===o.data.responseData)throw new Error("URL is incorrect or does not contain RSS Feed data");var l;l=o.data.responseData.feed;var n={title:l.description,link:l.link,category:t.category,articles:[],user:r.userID()};console.log(l);for(var a=0;a<l.entries.length;a++){var s={},i=document.createElement("content");i.innerHTML=l.entries[a].content;var c;c=void 0===$(i).find("img")[0]?"":$(i).find("img")[0].src,s.title=l.entries[a].title,s.link=l.entries[a].link,s.content=l.entries[a].contentSnippet,s.img=c,s.date=l.entries[a].publishedDate,n.articles.push(s)}return e.post("/users/"+r.userID()+"/addFeed",n,{headers:{Authorization:"Bearer "+r.getToken()}})},function(e){console.log(e)})},t.removeFeed=function(t){return console.log(t),e["delete"]("/users/"+r.userID()+"/deleteFeed/"+t,{headers:{Authorization:"Bearer "+r.getToken()}}).success(function(e){console.log("deleted")})},t}]);